<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小组主页 - StudyGroup Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; padding-top: 70px; }
        .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .stat-card { text-align: center; padding: 20px; }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .stat-label { color: #6c757d; font-size: 0.9rem; }
        .loading { background: #e9ecef; border-radius: 4px; min-height: 20px; }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/static/pages/group-list.html">
                <i class="fas fa-arrow-left me-2"></i>小组主页
            </a>
            <div class="d-flex align-items-center text-white">
                <span id="userName">用户</span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 小组信息 -->
        <div class="card mb-4">
            <div class="card-body">
                <h3 id="groupName" class="loading" style="height: 40px; width: 70%;"></h3>
                <div class="mt-2" id="groupBadges">
                    <span class="badge bg-primary me-2 loading" style="width: 120px; height: 28px;"></span>
                    <span class="badge bg-secondary loading" style="width: 80px; height: 28px;"></span>
                </div>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="row g-3 mb-4" id="statsContainer">
            <!-- 数据将通过JS动态加载 -->
            <div class="col-md-3 col-6">
                <div class="card stat-card">
                    <div class="loading" style="height: 40px; width: 60px; margin: 0 auto 10px;"></div>
                    <div class="loading" style="height: 16px; width: 80px; margin: 0 auto;"></div>
                </div>
            </div>
            <!-- 重复3次... -->
        </div>

        <!-- 操作按钮 -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-4">
                <button class="btn btn-primary w-100 py-3" onclick="createTask()">
                    <i class="fas fa-plus-circle fa-2x mb-2 d-block"></i>创建任务
                </button>
            </div>
            <div class="col-6 col-md-4">
                <button class="btn btn-success w-100 py-3" onclick="uploadFile()">
                    <i class="fas fa-upload fa-2x mb-2 d-block"></i>上传文件
                </button>
            </div>
            <div class="col-6 col-md-4">
                <button class="btn btn-info w-100 py-3" onclick="viewTaskBoard()">
                    <i class="fas fa-tasks fa-2x mb-2 d-block"></i>任务看板
                </button>
            </div>
            <div class="col-6 col-md-4">
                <button class="btn btn-warning w-100 py-3" onclick="refreshData()">
                    <i class="fas fa-sync-alt fa-2x mb-2 d-block"></i>刷新数据
                </button>
            </div>
            <div class="col-6 col-md-4">
                <button class="btn btn-secondary w-100 py-3" onclick="viewMembers()">
                    <i class="fas fa-users fa-2x mb-2 d-block"></i>查看成员
                </button>
            </div>
        </div>

        <!-- 加载状态 -->
        <div class="alert alert-info" id="loadingAlert">
            <i class="fas fa-spinner fa-spin me-2"></i>正在加载真实数据...
        </div>

        <!-- 错误提示 -->
        <div class="alert alert-danger d-none" id="errorAlert"></div>
    </div>

    <!-- 创建任务模态框 -->
    <div class="modal fade" id="taskModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建新任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="taskInput" rows="3" placeholder="请输入任务描述..."></textarea>
                    <div class="alert alert-warning mt-2 d-none" id="taskError"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button class="btn btn-primary" onclick="submitTask()">提交</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://studygroup-backend-production-9cad.up.railway.app';
        let currentGroupId = null;
        let currentUser = null;

        // ✅ 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 获取小组ID
            const params = new URLSearchParams(window.location.search);
            currentGroupId = params.get('group_id') || localStorage.getItem('currentGroupId');
            
            if (!currentGroupId) {
                showError('未指定小组，返回列表页');
                setTimeout(() => window.location.href = '/static/pages/group-list.html', 2000);
                return;
            }

            // 获取用户信息
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                currentUser = JSON.parse(userInfo);
                document.getElementById('userName').textContent = currentUser.user_name || '用户';
            }

            // 开始加载真实数据
            loadRealData();
        });

        // ✅ 加载真实数据（核心函数）
        async function loadRealData() {
            try {
                console.time('数据加载总耗时');
                
                // 1. 并行加载关键数据
                const [groupData, progressData] = await Promise.all([
                    fetchGroupInfo(),
                    fetchTaskProgress()
                ]);

                // 2. 更新小组信息
                if (groupData) {
                    updateGroupInfo(groupData);
                }

                // 3. 更新统计卡片
                if (progressData) {
                    updateStats(progressData);
                }

                // 4. 延迟加载次要数据
                setTimeout(() => {
                    fetchSecondaryData();
                }, 500);

                console.timeEnd('数据加载总耗时');
                
                // 隐藏加载提示
                document.getElementById('loadingAlert').className = 'alert alert-success';
                document.getElementById('loadingAlert').innerHTML = '<i class="fas fa-check-circle me-2"></i>数据加载完成';
                setTimeout(() => {
                    document.getElementById('loadingAlert').style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('数据加载失败:', error);
                showError('数据加载失败，请检查网络连接');
            }
        }

        // ✅ 获取小组信息
        async function fetchGroupInfo() {
            try {
                const response = await fetch(`${API_BASE}/group/${currentGroupId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.code === 200) {
                    return data.data;
                } else {
                    throw new Error(data.msg || '获取小组信息失败');
                }
            } catch (error) {
                console.warn('小组信息获取失败:', error);
                return null;
            }
        }

        // ✅ 获取任务进度
        async function fetchTaskProgress() {
            try {
                const response = await fetch(`${API_BASE}/task/group/${currentGroupId}/progress`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.code === 200) {
                    return data.data;
                } else {
                    throw new Error(data.msg || '获取进度失败');
                }
            } catch (error) {
                console.warn('进度获取失败:', error);
                return null;
            }
        }

        // ✅ 获取次要数据（文件、成员）
        async function fetchSecondaryData() {
            try {
                const [filesRes, membersRes] = await Promise.all([
                    fetch(`${API_BASE}/file/group/${currentGroupId}`).catch(() => null),
                    fetch(`${API_BASE}/group/${currentGroupId}/members?user_id=${currentUser?.user_id || 1}`).catch(() => null)
                ]);

                // 处理文件数据
                if (filesRes && filesRes.ok) {
                    const filesData = await filesRes.json();
                    if (filesData.code === 200) {
                        updateFileStats(filesData.data);
                    }
                }

                // 处理成员数据
                if (membersRes && membersRes.ok) {
                    const membersData = await membersRes.json();
                    if (membersData.code === 200) {
                        updateMemberStats(membersData.data);
                    }
                }
            } catch (error) {
                console.warn('次要数据获取失败:', error);
            }
        }

        // ✅ 更新小组信息
        function updateGroupInfo(data) {
            const groupName = document.getElementById('groupName');
            groupName.textContent = data.group_name || '未命名小组';
            groupName.className = '';
            
            const badges = document.getElementById('groupBadges');
            badges.innerHTML = `
                <span class="badge bg-primary me-2">
                    <i class="fas fa-book me-1"></i>${data.course_name || '未设置课程'}
                </span>
                <span class="badge bg-secondary">
                    <i class="fas fa-calendar me-1"></i>${formatDate(data.create_time)}
                </span>
            `;
        }

        // ✅ 更新统计卡片
        function updateStats(progressData) {
            const total = progressData.total || 0;
            const completed = progressData.completed || 0;
            const pending = progressData.pending || 0;
            const progress = progressData.progress || 0;
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="col-md-3 col-6">
                    <div class="card stat-card">
                        <div class="stat-number text-primary">${total}</div>
                        <div class="stat-label">总任务数</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card stat-card">
                        <div class="stat-number text-success">${completed}</div>
                        <div class="stat-label">已完成</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card stat-card">
                        <div class="stat-number text-warning">${pending}</div>
                        <div class="stat-label">待办</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card stat-card">
                        <div class="stat-number text-info" id="fileCount">0</div>
                        <div class="stat-label">文件数</div>
                    </div>
                </div>
            `;
        }

        // ✅ 更新文件统计
        function updateFileStats(files) {
            const fileCount = files ? files.length : 0;
            const fileCountEl = document.getElementById('fileCount');
            if (fileCountEl) {
                fileCountEl.textContent = fileCount;
            }
        }

        // ✅ 更新成员统计
        function updateMemberStats(members) {
            const memberCount = members ? members.length : 0;
            // 可以在这里更新成员相关的显示
            console.log(`成员数量: ${memberCount}`);
        }

        // ✅ 创建任务
        function createTask() {
            if (!currentUser) {
                showError('请先登录');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('taskModal'));
            modal.show();
        }

        // ✅ 提交任务
        async function submitTask() {
            const taskDesc = document.getElementById('taskInput').value.trim();
            
            if (!taskDesc) {
                showTaskError('请输入任务描述');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/task/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        task_desc: taskDesc,
                        group_id: parseInt(currentGroupId),
                        leader_id: currentUser.user_id
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.code === 200) {
                    // 关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                    document.getElementById('taskInput').value = '';
                    
                    // 刷新数据
                    refreshData();
                    
                    // 显示成功消息
                    showAlert('任务创建成功！', 'success');
                } else {
                    showTaskError(data.msg || '创建失败');
                }
            } catch (error) {
                console.error('创建任务失败:', error);
                showTaskError('网络错误，请重试');
            }
        }

        // ✅ 刷新数据
        function refreshData() {
            document.getElementById('loadingAlert').style.display = 'block';
            document.getElementById('loadingAlert').className = 'alert alert-info';
            document.getElementById('loadingAlert').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>刷新数据中...';
            
            loadRealData();
        }

        // ✅ 其他功能
        function uploadFile() {
            window.location.href = `/static/pages/file-library.html?group_id=${currentGroupId}`;
        }

        function viewTaskBoard() {
            window.location.href = `/static/pages/task-board.html?group_id=${currentGroupId}`;
        }

        function viewMembers() {
            const groupId = localStorage.getItem('currentGroupId');
            if (groupId) {
                window.location.href = `/static/pages/member-manage.html?group_id=${groupId}`;
            } else {
                alert('未找到小组信息，请重新进入小组');
            }
        }

        // ✅ 工具函数
        function formatDate(dateString) {
            if (!dateString) return '未知日期';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN');
            } catch {
                return dateString;
            }
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.classList.remove('d-none');
        }

        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed bottom-3 end-3`;
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        function showTaskError(message) {
            const errorDiv = document.getElementById('taskError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
            setTimeout(() => errorDiv.classList.add('d-none'), 3000);
        }
    </script>
</body>
</html>