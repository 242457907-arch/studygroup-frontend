<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小组列表 - StudyGroup Hub</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .container {
            max-width: 1200px;
        }
        .welcome-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .group-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
        }
        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .group-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        .group-course {
            color: #667eea;
            font-weight: 500;
            margin-bottom: 5px;
        }
        .group-meta {
            display: flex;
            gap: 15px;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        .group-progress {
            margin-top: 15px;
        }
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-detail {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        .progress-detail i {
            font-size: 0.9rem;
        }
        .no-groups {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        .no-groups i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }
        .btn-create {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .modal-content {
            border-radius: 10px;
            border: none;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        .alert {
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-users me-2"></i>
                StudyGroup Hub
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        <div class="user-avatar me-2" id="userAvatar">
                            <span id="avatarText">U</span>
                        </div>
                        <span id="userName">用户</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="viewProfile()"><i class="fas fa-user me-2"></i>个人资料</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>退出登录</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 欢迎卡片 -->
        <div class="welcome-card">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 id="welcomeText">欢迎回来！</h4>
                    <p class="text-muted mb-0" id="groupCount">正在加载小组信息...</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary me-2" onclick="refreshGroups()" title="刷新" id="refreshBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-create" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                            <i class="fas fa-plus me-2"></i>创建新小组
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 小组列表 -->
        <div class="row" id="groupsContainer">
            <!-- 小组卡片将通过JS动态生成 -->
            <div class="col-12">
                <div class="no-groups" id="noGroupsMessage">
                    <i class="fas fa-users"></i>
                    <h5>暂无小组</h5>
                    <p>点击上方按钮创建你的第一个小组</p>
                </div>
            </div>
        </div>

        <!-- 加载指示器 -->
        <div class="text-center mt-4 d-none" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2 text-muted">正在加载小组数据...</p>
        </div>

        <!-- 全局警告 -->
        <div id="globalAlert"></div>
    </div>

    <!-- 创建小组模态框 -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>创建新小组</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createGroupForm">
                        <div class="mb-3">
                            <label for="groupName" class="form-label">小组名称</label>
                            <input type="text" class="form-control" id="groupName" 
                                   placeholder="例如：数据库项目小组" required>
                            <div class="form-text">建议名称清晰明了，2-20个字符</div>
                        </div>
                        <div class="mb-3">
                            <label for="courseId" class="form-label">关联课程</label>
                            <select class="form-select" id="courseId" required>
                                <option value="">请选择课程</option>
                                <!-- 课程选项将通过JS动态加载 -->
                            </select>
                            <div class="form-text">暂时使用模拟课程数据</div>
                        </div>
                        <div class="alert alert-warning d-none" id="formAlert"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="createGroup()" id="createGroupBtn">
                        <span>创建小组</span>
                        <span class="spinner-border spinner-border-sm d-none" id="createSpinner"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 成功提示模态框 -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 id="successMessage">创建成功！</h5>
                    <p class="text-muted" id="successDetail">正在跳转到小组主页...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API基础URL - 使用你的基础接口地址
        const API_BASE = 'http://studygroup-backend-production-9cad.up.railway.app';
        
        // 全局变量
        let currentUser = null;
        let groupsCache = null;
        let lastFetchTime = 0;
        const CACHE_DURATION = 30000; // 缓存30秒

        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', function() {
            // 从localStorage获取用户信息
            loadUserInfo();
            
            // 加载课程列表（模拟数据）
            loadCourses();
            
            // 加载用户的小组列表
            loadUserGroups();
        });

        // 加载用户信息
        function loadUserInfo() {
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                currentUser = JSON.parse(userInfo);
                updateUserUI();
            } else {
                // 如果没有登录信息，跳转到登录页
                window.location.href = '/static/pages/login.html';
            }
        }

        // 更新用户界面
        function updateUserUI() {
            if (currentUser) {
                // 更新欢迎信息
                document.getElementById('welcomeText').textContent = 
                    `欢迎回来，${currentUser.user_name || '用户'}！`;
                
                // 更新用户头像
                const avatarText = document.getElementById('avatarText');
                const userName = document.getElementById('userName');
                
                if (currentUser.user_name) {
                    avatarText.textContent = currentUser.user_name.charAt(0).toUpperCase();
                    userName.textContent = currentUser.user_name;
                }
            }
        }

        // 加载课程列表（模拟数据）
        function loadCourses() {
            // 暂时使用模拟数据，实际应该调用API获取课程列表
            const courses = [
                { course_id: 1, course_name: '数据库系统', course_code: 'CS301' },
                { course_id: 2, course_name: 'Web开发', course_code: 'CS302' },
                { course_id: 3, course_name: '数据结构', course_code: 'CS201' }
            ];
            
            // 填充课程选择框
            const courseSelect = document.getElementById('courseId');
            courseSelect.innerHTML = '<option value="">请选择课程</option>';
            
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.course_id;
                option.textContent = `${course.course_name} (${course.course_code})`;
                courseSelect.appendChild(option);
            });
        }

        // 加载用户的小组列表
        async function loadUserGroups(forceRefresh = false) {
            if (!currentUser) {
                showGlobalAlert('danger', '用户未登录');
                return;
            }
            
            // 使用缓存逻辑
            const now = Date.now();
            if (!forceRefresh && groupsCache && (now - lastFetchTime) < CACHE_DURATION) {
                renderGroups(groupsCache);
                return;
            }
            
            // 显示加载指示器
            document.getElementById('loadingIndicator').classList.remove('d-none');
            document.getElementById('noGroupsMessage').classList.add('d-none');
            document.getElementById('refreshBtn').disabled = true;
            
            try {
                // 1. 获取用户的小组列表
                const groupsResponse = await fetch(`${API_BASE}/group/user/${currentUser.user_id}`);
                
                if (!groupsResponse.ok) {
                    throw new Error(`HTTP ${groupsResponse.status}`);
                }
                
                const groupsData = await groupsResponse.json();
                
                if (groupsData.code === 200) {
                    const groups = groupsData.data || [];
                    
                    // 2. 为每个小组获取任务进度
                    const groupsWithProgress = await Promise.all(
                        groups.map(async (group) => {
                            try {
                                const progressResponse = await fetch(`${API_BASE}/task/group/${group.group_id}/progress`);
                                
                                if (progressResponse.ok) {
                                    const progressData = await progressResponse.json();
                                    if (progressData.code === 200) {
                                        return {
                                            ...group,
                                            progress: progressData.data.progress || 0,
                                            task_count: progressData.data.total || 0,
                                            completed_tasks: progressData.data.completed || 0,
                                            pending_tasks: progressData.data.pending || 0
                                        };
                                    }
                                }
                            } catch (error) {
                                console.warn(`获取小组 ${group.group_id} 进度失败:`, error);
                            }
                            
                            // 如果获取进度失败，使用默认值
                            return {
                                ...group,
                                progress: 0,
                                task_count: 0,
                                completed_tasks: 0,
                                pending_tasks: 0
                            };
                        })
                    );
                    
                    // 更新缓存
                    groupsCache = groupsWithProgress;
                    lastFetchTime = Date.now();
                    
                    renderGroups(groupsWithProgress);
                    
                } else {
                    showGlobalAlert('warning', groupsData.msg || '加载小组失败');
                    document.getElementById('noGroupsMessage').classList.remove('d-none');
                }
                
            } catch (error) {
                console.error('加载小组列表失败:', error);
                showGlobalAlert('danger', '网络错误，请检查后端服务是否启动');
                document.getElementById('noGroupsMessage').classList.remove('d-none');
            } finally {
                // 隐藏加载指示器，恢复按钮
                document.getElementById('loadingIndicator').classList.add('d-none');
                document.getElementById('refreshBtn').disabled = false;
            }
        }

        // 渲染小组列表
        function renderGroups(groups) {
            const container = document.getElementById('groupsContainer');
            const noGroupsMessage = document.getElementById('noGroupsMessage');
            
            if (!groups || groups.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="no-groups">
                            <i class="fas fa-users"></i>
                            <h5>暂无小组</h5>
                            <p>点击上方按钮创建你的第一个小组</p>
                        </div>
                    </div>
                `;
                document.getElementById('groupCount').textContent = '您还没有加入任何小组';
                return;
            }
            
            // 更新小组数量
            document.getElementById('groupCount').textContent = 
                `您共参与了 ${groups.length} 个小组`;
            
            // 清空容器
            container.innerHTML = '';
            
            // 渲染每个小组卡片
            groups.forEach(group => {
                const progress = group.progress || 0;
                const taskCount = group.task_count || 0;
                const completedTasks = group.completed_tasks || 0;
                const pendingTasks = group.pending_tasks || 0;
                
                // 根据进度设置颜色
                let progressColor = 'bg-success';
                if (progress < 30) progressColor = 'bg-danger';
                else if (progress < 70) progressColor = 'bg-warning';
                
                const groupCard = `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="group-card" onclick="enterGroup(${group.group_id})" style="cursor: pointer;">
                        <div class="group-header">
                            <h5 class="group-title">${group.group_name || '未命名小组'}</h5>
                            <span class="badge bg-primary">${group.member_count || 1}人</span>
                        </div>
                        <div class="group-course">
                            <i class="fas fa-book me-1"></i>
                            ${group.course_name || '未指定课程'} ${group.semester ? `(${group.semester})` : ''}
                        </div>
                        <div class="group-meta">
                            <span><i class="fas fa-calendar me-1"></i>${formatDate(group.create_time)}</span>
                            <span><i class="fas fa-tasks me-1"></i>${taskCount}个任务</span>
                        </div>
                        <div class="group-progress">
                            <div class="progress-text">
                                <span>任务进度</span>
                                <span>${progress}% (${completedTasks}/${taskCount})</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar ${progressColor}" role="progressbar" 
                                     style="width: ${progress}%"></div>
                            </div>
                            <div class="progress-detail mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-check-circle text-success me-1"></i>已完成：${completedTasks}
                                    <i class="fas fa-clock text-warning ms-3 me-1"></i>待办：${pendingTasks}
                                </small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation();enterGroup(${group.group_id})">
                                <i class="fas fa-door-open me-1"></i>进入小组
                            </button>
                        </div>
                    </div>
                </div>
                `;
                
                container.innerHTML += groupCard;
            });
        }

        // 创建小组
        async function createGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            const courseId = document.getElementById('courseId').value;
            
            // 表单验证
            if (!groupName) {
                showFormAlert('请输入小组名称');
                return;
            }
            if (groupName.length > 20) {
                showFormAlert('小组名称不能超过20个字符');
                return;
            }
            if (!courseId) {
                showFormAlert('请选择关联课程');
                return;
            }
            
            if (!currentUser) {
                showFormAlert('用户未登录');
                return;
            }
            
            // 显示加载状态
            const createBtn = document.getElementById('createGroupBtn');
            const createSpinner = document.getElementById('createSpinner');
            createBtn.disabled = true;
            createSpinner.classList.remove('d-none');
            
            try {
                // 调用创建小组API
                const response = await fetch(`${API_BASE}/group/create`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        group_name: groupName,
                        course_id: parseInt(courseId),
                        creator_id: currentUser.user_id
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.code === 200) {
                    // 创建成功
                    showSuccessModal(data.data.group_id, groupName);
                    
                    // 关闭创建模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createGroupModal'));
                    modal.hide();
                    
                    // 重置表单
                    document.getElementById('createGroupForm').reset();
                    
                    // 刷新小组列表
                    setTimeout(() => loadUserGroups(true), 1000);
                    
                } else {
                    showFormAlert(data.msg || `创建失败 (${data.code})`);
                }
                
            } catch (error) {
                console.error('创建小组失败:', error);
                showFormAlert('网络错误，请检查连接');
            } finally {
                // 恢复按钮状态
                createBtn.disabled = false;
                createSpinner.classList.add('d-none');
            }
        }

        // 显示成功模态框
        function showSuccessModal(groupId, groupName) {
            document.getElementById('successMessage').textContent = `小组"${groupName}"创建成功！`;
            document.getElementById('successDetail').textContent = '正在跳转到小组主页...';
            
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();
            
            // 3秒后跳转
            setTimeout(() => {
                enterGroup(groupId);
            }, 3000);
        }

        // 进入小组
        function enterGroup(groupId) {
            // 保存当前小组ID到localStorage
            localStorage.setItem('currentGroupId', groupId);
            
            // 跳转到小组主页（需要创建group-home.html）
            window.location.href = '/static/pages/group-home.html?group_id=' + groupId;
            
            // 临时提示
            alert(`即将进入小组 ${groupId} 的主页`);
        }

        // 刷新小组列表
        function refreshGroups() {
            loadUserGroups(true);
        }

        // 查看个人资料
        function viewProfile() {
            if (currentUser) {
                alert(`用户ID: ${currentUser.user_id}\n用户名: ${currentUser.user_name}\n联系方式: ${currentUser.contact}`);
            }
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('userInfo');
            localStorage.removeItem('currentGroupId');
            window.location.href = '/static/pages/login.html';
        }

        // 显示表单警告
        function showFormAlert(message) {
            const alertDiv = document.getElementById('formAlert');
            alertDiv.textContent = message;
            alertDiv.classList.remove('d-none');
            
            setTimeout(() => {
                alertDiv.classList.add('d-none');
            }, 5000);
        }

        // 显示全局警告
        function showGlobalAlert(type, message) {
            const alertDiv = document.getElementById('globalAlert');
            alertDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                </div>
            `;
            
            setTimeout(() => {
                if (alertDiv.firstChild) {
                    alertDiv.firstChild.remove();
                }
            }, 5000);
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '未知日期';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return '今天';
                if (diffDays === 1) return '昨天';
                if (diffDays < 7) return `${diffDays}天前`;
                
                return date.toLocaleDateString('zh-CN', { 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch {
                return dateString;
            }
        }

        // 添加一个测试函数，用于检查API连接
        function testAPIConnection() {
            fetch(`${API_BASE}/user/1`)
                .then(response => response.json())
                .then(data => {
                    console.log('API测试结果:', data);
                    showGlobalAlert('info', `API连接正常，用户: ${data.data?.user_name || '未知'}`);
                })
                .catch(error => {
                    console.error('API测试失败:', error);
                    showGlobalAlert('danger', 'API连接失败，请检查后端服务');
                });
        }
    </script>
</body>
</html>